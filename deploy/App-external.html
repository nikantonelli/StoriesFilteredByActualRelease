<!DOCTYPE html>
<html>
<head>
    <title>StoriesFilteredByActualRelease</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc3/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Rally.apps.StoriesByCustomStoryField.App",{extend:"Rally.app.App",componentCls:"app",config:{defaultSettings:[{name:"filterByField",value:"State"},{name:"wsapiName",value:"State"},{name:"timeBox",value:!1}]},id:"MainApp",items:[{xtype:"container",itemId:"header",layout:"column",border:5,style:{borderColor:Rally.util.Colors.cyan,borderStyle:"solid"},items:[{xtype:"container",margin:10,itemId:"selectorBox"},{xtype:"container",margin:10,itemId:"disableBox"},{xtype:"container",itemId:"notBox",margin:10},{xtype:"container",margin:10,itemId:"buttonBox"}]},{xtype:"container",itemId:"body"}],storyGrid:null,PageSize:200,fieldName:void 0,fieldTitle:void 0,getSettingsFields:function(){return Rally.apps.StoriesByCustomStoryField.Settings.getFields(this)},_updateGrid:function(app){app.storyGrid&&app.storyGrid.destroy(),app._createGrid(app)},_createFilter:function(app){var filters=[];if(Ext.getCmp("releaseFilterDisable").getValue()===!1){var releasefilter=Ext.create("Rally.data.wsapi.Filter",{property:app.timeBoxType+".ObjectID",operator:app.down("#releaseNot").getValue()?"!=":"=",value:Rally.util.Ref.getOidFromRef(app.down("#timeBoxSelector").getValue())});filters.push(releasefilter)}if(Ext.getCmp("fieldFilterDisable").getValue()===!1){var fieldfilter=Ext.create("Rally.data.wsapi.Filter",{property:app.fieldName,operator:app.down("#fieldNot").getValue()?"!=":"=",value:app.down("#fieldSelector").getValue()});filters.push(fieldfilter)}if(Ext.getCmp("stateFilterDisable").getValue()===!1){var statefilter=Ext.create("Rally.data.wsapi.Filter",{property:"ScheduleState",operator:app.down("#stateNot").getValue()?"!=":"=",value:app.down("#stateSelector").getValue()});filters.push(statefilter)}return filters},_createCfg:function(app){var colCfgs=[{dataIndex:"Name",text:"Title"},{dataIndex:"Project",text:"Team"},{dataIndex:"SubmittedBy",text:"Submitted By"},{dataIndex:"Owner",text:"Owner"}];if(Ext.getCmp("releaseFilterDisable").getValue()===!0||Ext.getCmp("releaseNot").getValue()===!0){var releaseClm={dataIndex:app.timeBoxType,text:app.timeBoxType};colCfgs.push(releaseClm)}if(Ext.getCmp("stateFilterDisable").getValue()===!0||Ext.getCmp("stateNot").getValue()===!0){var stateClm={dataIndex:"ScheduleState",text:"Schedule State"};colCfgs.push(stateClm)}if(Ext.getCmp("fieldFilterDisable").getValue()===!0||Ext.getCmp("fieldNot").getValue()===!0){var fieldClm={dataIndex:app.fieldName,text:app.fieldTitle};colCfgs.push(fieldClm)}return colCfgs},_createGrid:function(app,fieldValue,releaseValue,stateValue){var storiessFound=[],StoryStore=Ext.create("Rally.data.wsapi.TreeStoreBuilder").build({autoLoad:!0,enableHierarchy:!0,emptyText:"<p align=center>No Stories Found.</p>",models:["UserStory"],pageSize:app.PageSize,limitParam:void 0,fetch:[app.timeBoxType,"ScheduleState",app.fieldName,"CreationDate"],filters:app._createFilter(app)}).then({success:function(store){app.storyGrid=Ext.create("Rally.ui.grid.TreeGrid",{columnCfgs:app._createCfg(app),store:store,sortableColumns:!0})}});app.down("#body").add(app.storyGrid)},timeBoxType:"Iteration",launch:function(){var app=this,filterField=this.getSetting("filterByField");void 0===filterField?(app.fieldName="State",app.fieldTitle="State"):(app.fieldName=filterField,app.fieldTitle=app.getSetting("wsapiName"));var timeBoxField=app.getSetting("timeBox");timeBoxField&&(app.timeBoxType="Release");var START_DATE_FIELD=app.timeBoxType+"StartDate",END_DATE_FIELD=app.timeBoxType+"Date";"Iteration"==app.timeBoxType&&(START_DATE_FIELD="StartDate",END_DATE_FIELD="EndDate");var comboType="Rally.ui.combobox."+app.timeBoxType+"ComboBox",timeBoxSelector=Ext.create(comboType,{width:400,fieldLabel:"Rally "+app.timeBoxType+": ",allowNoEntry:!0,id:"timeBoxSelector",storeConfig:{fetch:["Name",START_DATE_FIELD,END_DATE_FIELD,"ObjectID","State","PlannedVelocity"],sorters:[{property:START_DATE_FIELD,direction:"DESC"},{property:END_DATE_FIELD,direction:"DESC"}],model:Ext.identityFn(app.timeBoxType)},listeners:{ready:function(thing,value){app.doStateSelector(app,value)},select:function(field,e){app._updateGrid(app)}}}),disableSelector=Ext.create("Ext.container.Container",{items:[{xtype:"fieldcontainer",region:"center",border:"0 3 0 3",fieldLabel:"Filter Disable",defaultType:"checkboxfield",items:[{boxLabel:app.timeBoxType,name:"all",value:!1,id:"releaseFilterDisable"},{boxLabel:"ScheduleState",name:"state",value:!0,id:"stateFilterDisable"},{boxLabel:app.fieldTitle,name:"field",value:!0,id:"fieldFilterDisable"}]}]}),notSelector=Ext.create("Ext.container.Container",{items:[{xtype:"fieldcontainer",fieldLabel:"Apply Inverse Filter",defaultType:"checkboxfield",items:[{boxLabel:app.timeBoxType,name:"all",value:!1,id:"releaseNot"},{boxLabel:"ScheduleState",name:"state",value:!1,id:"stateNot"},{boxLabel:app.fieldTitle,name:"field",value:!1,id:"fieldNot"}]}]}),goButton=Ext.create("Ext.Button",{text:"Run Query",color:Rally.util.Colors.logo_red,handler:function(){app._updateGrid(app)}});this.down("#selectorBox").add(timeBoxSelector),this.down("#disableBox").add(disableSelector),this.down("#notBox").add(notSelector),this.down("#buttonBox").add(goButton)},doFieldSelector:function(app,releaseValue,stateValue){var fieldSelector=Ext.create("Rally.ui.combobox.FieldValueComboBox",{fieldLabel:app.fieldTitle+": ",allowNoEntry:!0,allowBlank:!0,autoScroll:!0,autoExpand:!0,anyMatch:!0,id:"fieldSelector",model:"UserStory",field:app.fieldName,listeners:{ready:function(thing,fieldValue){app._createGrid(app,fieldValue,releaseValue,stateValue)}}});this.down("#selectorBox").add(fieldSelector)},doStateSelector:function(app,fieldValue,releaseValue){var stateSelector=Ext.create("Rally.ui.combobox.FieldValueComboBox",{fieldLabel:"Current State: ",allowBlank:!0,allowNoEntry:!0,autoScroll:!0,autoExpand:!0,anyMatch:!0,id:"stateSelector",model:"UserStory",field:"ScheduleState",listeners:{ready:function(thing,stateValue){app.doFieldSelector(app,releaseValue,stateValue)}}});this.down("#selectorBox").add(stateSelector)}});
                Ext.define("Rally.apps.StoriesByCustomStoryField.Settings",{singleton:!0,requires:["Rally.apps.StoriesByCustomStoryField.App","Rally.ui.combobox.FieldComboBox"],getFields:function(context){var items=[{name:"timeBox",xtype:"rallycheckboxfield",fieldLabel:"Use Releases"},{name:"filterByField",xtype:"rallyfieldcombobox",model:"UserStory",fieldLabel:"Filter by",listeners:{select:function(record){Ext.getCmp("wsapiName").setValue(record.rawValue)},ready:function(combo){combo.store.filterBy(function(record){var attr=record.get("fieldDefinition").attributeDefinition;return attr&&attr.Filterable&&"OBJECT"!==attr.AttributeType&&"COLLECTION"!==attr.AttributeType}),combo.getRecord()&&this.fireEvent("fieldselected",combo.getRecord())}}},{name:"wsapiName",id:"wsapiName",fieldLabel:"WSAPI Field Name",xtype:"rallytextfield",readOnly:!0,border:0,hidden:!0}];return items}});

            Rally.launchApp('Rally.apps.StoriesByCustomStoryField.App', {
                name:"StoriesFilteredByActualRelease",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
